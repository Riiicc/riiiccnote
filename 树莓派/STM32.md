# STM32介绍
STM32系列32位微控制器基于Arm® Cortex®-M处理器，常用于嵌入式领域，智能车，无人机，物联网，工业控制；性能优异，功耗低；

STM32系列微控制器品种齐全，基于行业标准内核，提供了大量工具和软件选项以支持工程开发，非常适用于小型项目或端到端平台

![](https://hexoric-1310528773.cos.ap-beijing.myqcloud.com/hexo/STM32MCUs.png)


# ARM架构
ARM即 ARM公司，也指ARM处理器内核  
ARM公司设计ARM内核，半导体厂商完善内核周边电路并生产芯片  

ARM内核分为三大类 分别为 A系列(Cortex-A) R系列(Cortex-R) M系列(Cortex-M)，面向不同应用场景


# STM32 资源

![](https://hexoric-1310528773.cos.ap-beijing.myqcloud.com/hexo/stm32f1.png ':size=60%')

![](https://hexoric-1310528773.cos.ap-beijing.myqcloud.com/hexo/stm32片上资源外设.png ':size=60%')

STM32芯片命名规则  
![](https://hexoric-1310528773.cos.ap-beijing.myqcloud.com/hexo/Stm32命名规则.png)  



# GPIO
- GPIO（General Purpose Input Output）通用输入输出口
- 可配置为8种输入输出模式
- 引脚电平：`0V~3.3V`，部分引脚可容忍5V(引脚定义图电平IO中带有`FT`标识)
- **输出模式**下可控制端口输出高低电平，用以驱动LED、控制蜂鸣器、模拟通信协议(I2C,SPI,或者自定义协议)输出时序等
- **输入模式**下可读取端口的高低电平或电压，用于读取按键输入、外接模块电平信号输入、ADC电压采集、模拟通信协议接收数据等


## 基本结构 
![](https://hexoric-1310528773.cos.ap-beijing.myqcloud.com/hexo/GPIO基本结构.png ':size=60%')  

在STM32中，所有的GPIO都是挂载在`APB2外设总线`上的    
GPIO外设的名称是按照 `GPIOA`、`GPIOB`、`GPIOC` 这样来命名的     
每个GPIO外设总共有16个引脚，编号是从0到15，命名为`PA0、PA1...PB0、PB1...PC0...`    
每个GPIO内包含了`寄存器`和`驱动器`   -


`寄存器`就是特殊的存储器，内核可以通过`APB2总线`对其进行读写，`寄存器`的每一位都对应了一个引脚      
`输出寄存器`写1对应引脚输出`高电平`，写0输出`低电平`    
`输入寄存器`读取为1证明对应端口目前是`高电平`，读取为0就是`低电平`    

STM32中的寄存器都是32位的，但是引脚只有16位，所以寄存器中只有低16位对应的端口，高16位没有用到    

`驱动器`是为了增大GPIO的驱动能力


## GPIO位结构
![](https://hexoric-1310528773.cos.ap-beijing.myqcloud.com/hexo/GPIO位结构图.png ':size=60%')

上半部分（输入部分）来看   
IO引脚首先接入`两个保护二极管`，对输入电压进行限幅，上面的VDD接3.3V，下面的VSS接0V   
如果输入电压高于3.3V，上面的二极管就会导通，输入电压产生的电流就会直接流入VDD，而不会流入内部电路   
如果输入电压低于0V（低于VSS的电压），下面的二极管就会导通，电流直接流出VSS，不会从内部电路汲取电流    

上拉电阻-VDD和下拉电阻-VSS,开关可以通过程序进行配置   
上面导通，下面断开，就是`上拉输入`模式   
上面断开，下面导通，就是`下拉输入`模式  
上面断开，下面断开，就是`浮空输入`模式    

引脚悬空会导致输入的数据不确定，我们需要加上上拉电阻或者下拉电阻    
接入上拉电阻，引脚悬空时，还有上拉电阻来保证引脚的高电平    
接入下拉电阻，引脚悬空时，还有下拉电阻来保证引脚的低电平

TTL肖特基触发器(施密特触发器)  
作用就是对输入电压进行`整形`，如果输入电压大于某一阈值，输出就会瞬间升为高电平，如果低于某一阈值，输出就会瞬间降为低电平  
注意只有高于上限和低于下限输出才会变化，低于上限，高于下限输出仍会保持现状    

经过施密特触发器整形的波形就可以直接写入输入数据寄存器，再使用程序读取输入数据寄存器对应某一位的数据，就可以知道端口的输入电平了   
还有两个：  
模拟输入，是接在施密特触发器之前的
复用功能输入，连接到其他需要读取端口的外设上，比如串口的输入引脚等，需要数字量，所以再施密特触发器后面  





下半部分（输出部分）
输出有`输出数据寄存器`或者`片上外设`进行控制  
`输出数据寄存器`就是普通的IO口输出，写输出数据寄存器的某一位即可操作某个端口  
`位设置/清除寄存器`可以单独操作`输出数据寄存器`的某一位而不影响其他位(`输出数据寄存器`是同时操作16个端口，并且是同时读写，所以`位设置/清楚寄存器`很有必要)  

输出控制后接入两个MOS管 N-MOS 和P-MOS，MOS管就是一种电子开关，使用信号来控制开关的导通和关闭，开关负责降IO口接到VSS或者VDD，这里可以选择推挽，开漏，关闭三种输出模式

推挽模式下   
数据寄存器为1时，上管导通，下管断开，输出直接接到VDD，就是输出高电平  
数据寄存器为0时，上管断开，下管导通，输出直接接到VSS，就是输出低电平  
这种模式下，高低电平均有较强的驱动能力，所以推挽输出模式也叫强推输出模式，高低电平都有STM32绝对控制     

开漏模式下   
P-MOS是无效的，只有N-MOS在工作  
数据寄存器为1时，下管断开，输出相当于断开，也就是高阻模式    
数据寄存器为0时，下管导通，输出直接接到VSS，输出低电平    
这种模式下只有低电平有驱动能力，高电平是没有驱动能力的    
开漏模式可以作为通信协议的驱动方式，比如I2C通信，多机通信时避免干扰   
还可以输出5V的电平信号，引脚接入上拉电阻到5V电源

关闭
这两个MOS管都无效，也就是输出关闭，端口的电平由外部信号控制


## 8种工作模式  
![](https://hexoric-1310528773.cos.ap-beijing.myqcloud.com/hexo/GPIO模式.png ':size=60%')



# 中断 
中断：在主程序运行过程中，出现了特定的中断触发条件（中断源），使得CPU暂停当前正在运行的程序，转而去处理中断程序，处理完成后又返回原来被暂停的位置继续运行   
举例，引脚的电平跳变，定时器触发，串口接收到数据都能触发中断

中断优先级：当有多个中断源同时申请中断时，CPU会根据中断源的轻重缓急进行裁决，优先响应更加紧急的中断源

中断嵌套：当一个中断程序正在运行时，又有**新的更高优先级的中断源申请中断**，CPU再次暂停当前中断程序，转而去处理新的中断程序，处理完成后依次进行返回


**NVIC**使用NVIC统一管理中断，每个中断通道都拥有16个可编程的优先等级，可对优先级进行分组，进一步设置抢占优先级和响应优先级

![](https://hexoric-1310528773.cos.ap-beijing.myqcloud.com/hexo/stm32NVIC.png ':size=60%')

**NVIC优先级分组**  
- NVIC的中断优先级由优先级寄存器的4位（0~15）决定，这4位可以进行切分，分为高n位的抢占优先级和低4-n位的响应优先级
- 抢占优先级高的可以中断嵌套，响应优先级高的可以优先排队，抢占优先级和响应优先级均相同的按中断号排队

**EXTI（Extern Interrupt）外部中断**
- EXTI可以监测指定GPIO口的电平信号，当其指定的GPIO口产生电平变化时，EXTI将立即向NVIC发出中断申请，经过NVIC裁决后即可中断CPU主程序，使CPU执行EXTI对应的中断程序
- 支持的触发方式：上升沿/下降沿/双边沿/软件触发
- 支持的GPIO口：所有GPIO口，但相同的Pin不能同时触发中断
- 通道数：16个GPIO_Pin，外加PVD输出、RTC闹钟、USB唤醒、以太网唤醒
- 触发响应方式：中断响应/事件响应

![](https://hexoric-1310528773.cos.ap-beijing.myqcloud.com/hexo/stm32exti基本结构.png ':size=60%')


**AFIO复用IO口**


# TIM（Timer）定时器
定时器可以对输入的时钟进行计数，并在计数值达到设定值时触发中断  
16位计数器、预分频器、自动重装寄存器的时基单元，在72MHz计数时钟下可以实现最大59.65s的定时  
不仅具备基本的定时中断功能，而且还包含内外时钟源选择、输入捕获、输出比较、编码器接口、主从触发模式等多种功能  
根据复杂度和应用场景分为了高级定时器、通用定时器、基本定时器三种类型  

##  TIM定时器类型  
![](https://hexoric-1310528773.cos.ap-beijing.myqcloud.com/hexo/tim定时器类型.png ':size=60%')

从高级到基本 是不断向下兼容的































































# 参考

- [B站江科大自化协](https://www.bilibili.com/video/BV1th411z7sn)







